# Sentinel Hub - Docker Compose Configuration
# Start with: docker-compose up -d

version: '3.8'

services:
  # ===================
  # API Server
  # ===================
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    # SECURITY: Environment variables loaded from .env file
    # Copy .env.example to .env and fill in actual values
    # .env file is gitignored and should never be committed
    env_file:
      - .env
    ports:
      - "8080:8080"
    environment:
      # SECURITY: All environment variables MUST be set via .env file
      # See .env.example for required variables
      # NEVER use default values in production
      - DATABASE_URL=postgres://sentinel:${DB_PASSWORD}@db:5432/sentinel?sslmode=require
      - JWT_SECRET=${JWT_SECRET}
      - DOCUMENT_STORAGE=/data/documents
      - BINARY_STORAGE=/data/binaries
      - RULES_STORAGE=/data/rules
      - OLLAMA_HOST=http://ollama:11434
      - CORS_ORIGIN=${CORS_ORIGIN}
      - LOG_LEVEL=info
    volumes:
      - document_storage:/data/documents
      - binary_storage:/data/binaries
      - rules_storage:/data/rules
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - sentinel-network

  # ===================
  # Document Processor
  # ===================
  # Contains all document parsing dependencies
  # (poppler, tesseract, pandoc, etc.)
  processor:
    build:
      context: ./processor
      dockerfile: Dockerfile
    # SECURITY: Environment variables loaded from .env file
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgres://sentinel:${DB_PASSWORD}@db:5432/sentinel?sslmode=require
      - DOCUMENT_STORAGE=/data/documents
      - OLLAMA_HOST=http://ollama:11434
      - WORKER_CONCURRENCY=${WORKER_CONCURRENCY:-4}
      # Azure AI Foundry Configuration (optional)
      - AZURE_AI_ENDPOINT=${AZURE_AI_ENDPOINT:-}
      - AZURE_AI_KEY=${AZURE_AI_KEY:-}
      - AZURE_AI_DEPLOYMENT=${AZURE_AI_DEPLOYMENT:-claude-opus-4-5}
      - AZURE_AI_API_VERSION=${AZURE_AI_API_VERSION:-2024-02-01}
    volumes:
      - document_storage:/data/documents
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - sentinel-network

  # ===================
  # Database
  # ===================
  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=sentinel
      # SECURITY: Password must be set via .env file
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=sentinel
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:5432:5432"  # Only localhost access
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sentinel -d sentinel"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - sentinel-network

  # ===================
  # LLM Service (Ollama)
  # ===================
  # Local LLM for knowledge extraction
  # No data leaves your server
  ollama:
    image: ollama/ollama:latest
    ports:
      - "127.0.0.1:11434:11434"  # Only localhost access
    volumes:
      - ollama_models:/root/.ollama
    restart: unless-stopped
    # Uncomment for GPU support:
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
    networks:
      - sentinel-network

volumes:
  postgres_data:
    driver: local
  document_storage:
    driver: local
  binary_storage:
    driver: local
  rules_storage:
    driver: local
  ollama_models:
    driver: local

networks:
  sentinel-network:
    name: sentinel-network

