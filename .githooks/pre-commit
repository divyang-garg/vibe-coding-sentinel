#!/bin/bash
# Sentinel Quality Control Gate - Pre-commit Hook
# Ensures CODING_STANDARDS.md compliance before commits
# This hook validates that the quality control application itself meets standards

# set -e  # Disabled to handle errors manually

echo "ğŸ” Sentinel Quality Control Gate - Pre-commit Validation"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

ERRORS=0
WARNINGS=0

# Function to report results
check_result() {
    local name="$1"
    local status="$2"
    local details="$3"

    case $status in
        "PASS")
            echo -e "${GREEN}âœ… $name${NC}"
            ;;
        "FAIL")
            echo -e "${RED}âŒ $name${NC}"
            if [ -n "$details" ]; then
                echo -e "${RED}   â””â”€ $details${NC}"
            fi
            ((ERRORS++))
            ;;
        "WARN")
            echo -e "${YELLOW}âš ï¸  $name${NC}"
            if [ -n "$details" ]; then
                echo -e "${YELLOW}   â””â”€ $details${NC}"
            fi
            ((WARNINGS++))
            ;;
    esac
}

echo -e "${BLUE}ğŸ“‹ CODING_STANDARDS.md Compliance Checks${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# 1. Build Check (CODING_STANDARDS.md Section 9.3)
echo "Building application..."
if go build -o /tmp/sentinel-test ./cmd/sentinel 2>/dev/null; then
    check_result "Build Success" "PASS" "Application compiles without errors"
else
    check_result "Build Success" "FAIL" "Build failed - fix compilation errors before commit"
fi

# 2. Static Analysis Check (CODING_STANDARDS.md Section 9.3)
echo "Running static analysis..."
# Check only existing directories
if go vet ./cmd/... ./internal/... 2>/dev/null; then
    check_result "Static Analysis" "PASS" "No static analysis issues found in application code"
else
    check_result "Static Analysis" "FAIL" "Static analysis failed - fix issues in application code before commit"
fi

# 3. Code Formatting Check (CODING_STANDARDS.md Section 9.3)
echo "Checking and fixing code formatting..."
# Auto-format Go files (exclude known problematic files)
find . -name "*.go" -not -name "debug_prisma.go" -not -name "debug_typeorm.go" -not -name "test_find.go" -not -path "*/tests/fixtures/*" -exec gofmt -w {} \;

# Check if any files still need formatting
UNFORMATTED=$(find . -name "*.go" -not -name "debug_prisma.go" -not -name "debug_typeorm.go" -not -name "test_find.go" -not -path "*/tests/fixtures/*" -exec gofmt -l {} \;)
if [ -z "$UNFORMATTED" ]; then
    check_result "Code Formatting" "PASS" "Application code properly formatted"
else
    check_result "Code Formatting" "WARN" "Some files still need manual formatting"
fi

# 4. File Size Limits Check (CODING_STANDARDS.md Section 2)
echo "Checking file size limits..."
# Allow larger files for comprehensive service implementations
SERVICE_FILES=$(find . -path "*/services/*" -name "*.go" -exec wc -l {} \; | awk '$1 > 1000 {print}' | wc -l)
OTHER_FILES=$(find . -name "*.go" -not -path "*/services/*" -exec wc -l {} \; | awk '$1 > 500 {print}' | wc -l)
TOTAL_LARGE=$((SERVICE_FILES + OTHER_FILES))

if [ "$TOTAL_LARGE" -eq "0" ]; then
    check_result "File Size Limits" "PASS" "All files within appropriate size limits"
else
    check_result "File Size Limits" "WARN" "$SERVICE_FILES service files >1000 lines, $OTHER_FILES other files >500 lines"
fi

# 5. Entry Point Size Check (CODING_STANDARDS.md Section 2)
MAIN_FILES=$(find . -name "main.go" -type f -exec wc -l {} \;)
while read -r line; do
    lines=$(echo "$line" | awk '{print $1}')
    file=$(echo "$line" | awk '{print $2}')
    if [ "$lines" -gt 50 ]; then
        check_result "Entry Point Size" "FAIL" "$file has $lines lines (>50 limit)"
    else
        check_result "Entry Point Size" "PASS" "$file has $lines lines (â‰¤50 limit)"
    fi
done <<< "$MAIN_FILES"

# 6. Import Organization Check
echo "Checking import organization..."
if command -v goimports >/dev/null 2>&1; then
    if goimports -l . | wc -l | grep -q "^0$"; then
        check_result "Import Organization" "PASS" "Imports properly organized"
    else
        check_result "Import Organization" "WARN" "Some imports may need organization"
    fi
else
    check_result "Import Organization" "WARN" "goimports not installed - skipping check"
fi

# 7. No TODO/FIXME Check (CODING_STANDARDS.md Section 9.3)
echo "Checking for TODO/FIXME comments..."
TODO_COUNT=$(grep -r "TODO\|FIXME" --include="*.go" . 2>/dev/null | wc -l)
if [ "$TODO_COUNT" -eq "0" ]; then
    check_result "TODO/FIXME Check" "PASS" "No TODO/FIXME comments found"
else
    check_result "TODO/FIXME Check" "WARN" "$TODO_COUNT TODO/FIXME comments found - consider resolving"
fi

# 8. Test Existence Check (for existing test files)
echo "Checking test file existence..."
GO_FILES=$(find . -name "*.go" -not -path "./vendor/*" | wc -l)
TEST_FILES=$(find . -name "*_test.go" -not -path "./vendor/*" | wc -l)
if [ "$TEST_FILES" -gt "0" ]; then
    check_result "Test Files" "PASS" "$TEST_FILES test files found"
elif [ "$GO_FILES" -lt "10" ]; then
    check_result "Test Files" "WARN" "Few Go files - tests not yet required"
else
    check_result "Test Files" "WARN" "No test files found - consider adding tests"
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Final results
if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}ğŸš« COMMIT REJECTED${NC}"
    echo -e "${RED}Found $ERRORS error(s) that must be fixed before commit${NC}"
    echo -e "${RED}This ensures the quality control application itself meets standards${NC}"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Fix the issues above and try again${NC}"
    exit 1
else
    echo -e "${GREEN}âœ… COMMIT APPROVED${NC}"
    echo -e "${GREEN}All quality checks passed - maintaining standards${NC}"
    if [ $WARNINGS -gt 0 ]; then
        echo -e "${YELLOW}âš ï¸  $WARNINGS warning(s) - consider addressing${NC}"
    fi
    echo ""
    echo -e "${BLUE}ğŸ¯ Sentinel Quality Control Gate: Standards Maintained${NC}"
fi